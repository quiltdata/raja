name: Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-raja
        with:
          python-version: '3.12'
          install-extras: dev

      - name: Determine tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "TAG=${{ github.event.release.tag_name }}" >> "$GITHUB_ENV"
          else
            echo "TAG=${{ github.ref_name }}" >> "$GITHUB_ENV"
          fi

      - name: Verify version matches tag
        shell: bash
        run: |
          python - <<'PY'
          import os
          import sys
          import tomllib

          tag = os.environ.get("TAG", "")
          version = tag.lstrip("v")
          with open("pyproject.toml", "rb") as handle:
            data = tomllib.load(handle)
          project_version = data.get("project", {}).get("version")
          if project_version != version:
            print(f"Tag {tag} does not match pyproject version {project_version}")
            sys.exit(1)
          PY

      - name: Quality checks
        run: ./poe check

      - name: Tests
        run: ./poe test

      - name: Build
        run: ./poe build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.10.0

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*

  release-notes:
    name: Update Release Notes
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: publish
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update release notes from changelog
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const tag = context.payload.release.tag_name;
            const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
            const pattern = new RegExp(`^## \\s*${tag}\\s*$`, 'm');
            const match = changelog.match(pattern);
            if (!match) {
              core.warning(`No changelog section found for ${tag}`);
              return;
            }
            const start = changelog.indexOf(match[0]);
            const rest = changelog.slice(start + match[0].length);
            const nextHeader = rest.search(/^##\s/m);
            const notes = nextHeader === -1 ? rest.trim() : rest.slice(0, nextHeader).trim();
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: notes,
            });
